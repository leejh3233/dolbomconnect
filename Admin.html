<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>돌봄 커넥트 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            -webkit-overflow-scrolling: touch;
        }

        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        /* 추가: 모바일 확대 방지 */
        .tab-btn {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>

<body class="min-h-[100dvh] pb-20 select-none">

    <!-- 로그인 오버레이 -->
    <div id="loginOverlay" class="fixed inset-0 bg-slate-900 z-[200] flex items-center justify-center p-6">
        <div class="max-w-sm w-full bg-white rounded-[3rem] p-10 text-center shadow-2xl">
            <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                    </path>
                </svg>
            </div>
            <h2 class="text-xl font-black text-slate-900 mb-2">관리자 로그인</h2>
            <input type="password" id="adminPwd" placeholder="••••••••"
                class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl mb-4 text-center outline-none font-bold text-lg">
            <button onclick="tryAdminLogin()" id="btnLogin"
                class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-lg">접속하기</button>
            <p id="loginError" class="text-red-500 text-[10px] font-bold mt-4 hidden">비밀번호가 틀렸습니다.</p>
        </div>
    </div>

    <!-- 메인 레이아웃 -->
    <div id="mainContent" class="hidden">
        <header class="bg-white border-b sticky top-0 z-50 px-6 py-4 shadow-sm">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-lg font-black tracking-tight text-slate-900">돌봄 커넥트 관리자</h1>
                    <button onclick="window.top.location.href='<?= scriptUrl ?>?page=portal'"
                        class="text-[10px] font-bold text-slate-400 hover:text-blue-600 transition-colors border-l pl-4">나가기</button>
                </div>
                <button onclick="loadData()" class="text-slate-400 hover:text-slate-900 transition-colors"><svg
                        class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg></button>
            </div>
        </header>

        <nav class="bg-white border-b px-6 flex gap-6 sticky top-[64px] z-40">
            <button onclick="switchTab('leads')" id="tab_leads"
                class="tab-btn active py-4 font-black text-xs">통합관리</button>
            <button onclick="switchTab('settle')" id="tab_settle" class="tab-btn py-4 font-black text-xs">통합정산</button>
            <button onclick="switchTab('partners')" id="tab_partners" class="tab-btn py-4 font-black text-xs">인원
                관리</button>
        </nav>

        <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">

            <!-- [1] 통합관리 탭 -->
            <div id="section_leads" class="space-y-6">
                <section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-xl">
                        <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-tight">전체 누적
                            정산완료</label>
                        <div id="summary_totalSettled" class="text-xl font-black text-blue-600">-</div>
                    </div>
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-xl">
                        <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-tight">전체 미정산
                            잔액</label>
                        <div id="summary_totalPending" class="text-xl font-black text-red-500">-</div>
                    </div>
                    <div
                        class="bg-white p-5 rounded-3xl border border-slate-100 shadow-xl flex flex-col justify-between">
                        <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-tight">필터
                            설정</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select id="filterMonth" onchange="applyFilters()"
                                class="bg-slate-50 p-2 rounded-xl text-[10px] font-black outline-none border-none"></select>
                            <select id="filterPartner" onchange="applyFilters()"
                                class="bg-slate-50 p-2 rounded-xl text-[10px] font-black outline-none border-none"></select>
                            <!-- [NEW] 정산 상태 필터 -->
                            <select id="filterSettlement" onchange="applyFilters()"
                                class="bg-slate-50 p-2 rounded-xl text-[10px] font-black outline-none border-none">
                                <option value="ALL">정산상태 전체</option>
                                <option value="미정산">미정산건 만</option>
                                <option value="정산완료">정산완료건 만</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-slate-900 p-5 rounded-3xl shadow-2xl flex justify-between items-center text-white">
                        <div class="text-center">
                            <div class="text-[8px] opacity-50 font-bold uppercase">예약</div>
                            <div id="sum_book" class="text-base font-black">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-[8px] opacity-50 font-bold uppercase">시공</div>
                            <div id="sum_comp" class="text-base font-black text-green-400">0</div>
                        </div>
                        <div class="text-center">
                            <div class="text-[8px] opacity-50 font-bold uppercase">필터 합계</div>
                            <div id="filteredIncentive" class="text-base font-black text-blue-400">0원</div>
                        </div>
                    </div>
                </section>

                <div class="bg-white rounded-3xl border border-slate-100 shadow-lg">
                    <div class="overflow-x-auto no-scrollbar">
                        <table class="w-full text-sm text-left min-w-[800px]">
                            <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                                <tr>
                                    <th class="px-6 py-4">일자/아파트</th>
                                    <th class="px-6 py-4">유입파트너</th>
                                    <th class="px-4 py-4 text-center">예약</th>
                                    <th class="px-4 py-4 text-center">시공</th>
                                    <th class="px-6 py-4">판매금액 입력</th>
                                    <th class="px-6 py-4">인센티브</th>
                                    <th class="px-6 py-4 text-right">정산상태</th>
                                </tr>
                            </thead>
                            <tbody id="leadTableBody" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- [2] 통합정산 탭 -->
            <div id="section_settle" class="hidden space-y-6">
                <!-- V13.0 필터 영역 추가 -->
                <section class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <label class="block text-[10px] font-black text-slate-400 mb-2">정산 기준 월</label>
                        <select id="settleMonth" onchange="renderSettleList()"
                            class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl outline-none font-bold text-xs"></select>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <label class="block text-[10px] font-black text-slate-400 mb-2">대상 구분</label>
                        <select id="settleType" onchange="renderSettleList()"
                            class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl outline-none font-bold text-xs">
                            <option value="ALL">파트너 구분 전체</option>
                            <option value="외부파트너">외부파트너 실적</option>
                            <option value="직원">사내 직원 실적</option>
                        </select>
                    </div>
                    <!-- [NEW] 정산 상태 필터 -->
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <label class="block text-[10px] font-black text-slate-400 mb-2">리스트 표시</label>
                        <select id="settleStatusFilter" onchange="renderSettleList()"
                            class="w-full px-4 py-2 bg-slate-50 border border-slate-100 rounded-xl outline-none font-bold text-xs">
                            <option value="PENDING">미정산 대기건만 보기</option>
                            <option value="SETTLED">정산 완료건 포함 보기</option>
                        </select>
                    </div>
                </section>

                <div class="bg-white rounded-3xl border border-slate-100 shadow-lg overflow-hidden">
                    <div class="p-6 border-b bg-slate-50/50 flex justify-between items-center">
                        <h2 class="text-sm font-black text-slate-800">파트너별 통합정산 현황</h2>
                        <span class="text-[10px] font-bold text-slate-400">시공완료 / 정산금액 집계</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[700px]">
                            <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                                <tr>
                                    <th class="px-6 py-4">대상자 (구분)</th>
                                    <th class="px-6 py-4">이월/과거 실적</th>
                                    <th class="px-6 py-4 text-blue-600">선택 월 실적</th>
                                    <th class="px-6 py-4">합계 (미정산액)</th>
                                    <th class="px-6 py-4">계좌 정보</th>
                                    <th class="px-6 py-4 text-right">매니저 처리</th>
                                </tr>
                            </thead>
                            <tbody id="settleListBody" class="divide-y divide-slate-50 text-xs"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- [3] 인원 관리 탭 -->
            <div id="section_partners" class="hidden space-y-6">
                <section class="bg-white p-8 rounded-3xl border border-slate-100 shadow-lg">
                    <h3 class="text-sm font-black mb-6">신규 인원 등록</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="reg_name" placeholder="이름"
                            class="flex-1 px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none text-sm font-bold">
                        <select id="reg_type"
                            class="flex-1 px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold">
                            <option value="직원">회사 직원</option>
                            <option value="외부파트너">파트너 / 외부파트너</option>
                        </select>
                        <button onclick="preRegister()"
                            class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black shadow-lg hover:brightness-110">등록</button>
                    </div>
                </section>
                <div class="bg-white rounded-3xl border border-slate-100 shadow-lg overflow-hidden">
                    <div class="p-6 border-b bg-slate-50/50 flex justify-between items-center">
                        <h3 class="text-sm font-black">인원 관리 리스트</h3>
                        <select id="partnerTypeFilter" onchange="renderPartners()"
                            class="bg-white border rounded-lg px-3 py-1 text-xs font-bold outline-none">
                            <option value="ALL">파트너 구분 전체</option>
                            <option value="직원">직원</option>
                            <option value="외부파트너">외부파트너</option>
                        </select>
                    </div>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 border-b">
                            <tr>
                                <th class="px-8 py-5">파트너 정보</th>
                                <th class="px-8 py-5">상태</th>
                                <th class="px-8 py-5 text-right">계약 관리</th>
                            </tr>
                        </thead>
                        <tbody id="partnerTableBody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- 정산 모달 -->
    <div id="bankModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-[3rem] p-10 max-w-sm w-full shadow-2xl animate-in zoom-in duration-200">
            <h3 class="text-2xl font-black text-slate-900 mb-8 pl-4 border-l-4 border-blue-600">통합정산 처리</h3>
            <div class="bg-slate-50 rounded-3xl p-6 mb-8 space-y-4">
                <div><span class="text-[10px] font-bold text-slate-400">대상자</span>
                    <div id="m_name" class="font-black text-lg">-</div>
                </div>
                <div><span class="text-[10px] font-bold text-slate-400">송금정보</span>
                    <div id="m_bank" class="text-blue-600 font-bold text-sm">-</div>
                </div>
                <div><span class="text-[10px] font-bold text-slate-400">일괄 정산액</span>
                    <div id="m_amt" class="text-3xl font-black text-slate-900">-</div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('bankModal').classList.add('hidden')"
                    class="flex-1 py-4 text-slate-400 font-bold">취소</button>
                <button id="btnBulkConfirm"
                    class="flex-[2] py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl">입금 및 정산 완료</button>
            </div>
        </div>
    </div>

    <script>
        var masterData = null;

        function tryAdminLogin() {
            var pwd = document.getElementById('adminPwd').value;
            google.script.run.withSuccessHandler(isValid => {
                if (isValid) { document.getElementById('loginOverlay').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); loadData(); }
                else alert("비밀번호가 틀립니다.");
            }).verifyAdminPassword(pwd);
        }

        function switchTab(t) {
            ['leads', 'settle', 'partners'].forEach(id => {
                document.getElementById('section_' + id).classList.toggle('hidden', id !== t);
                document.getElementById('tab_' + id).classList.toggle('active', id === t);
            });
        }

        function loadData() {
            google.script.run.withSuccessHandler(data => {
                masterData = data;
                initFilters();
                initSettleFilters();
                applyFilters();
                renderSettleList();
            }).getAdminData();
        }

        function initFilters() {
            var mF = document.getElementById('filterMonth');
            var pF = document.getElementById('filterPartner');
            var curM = mF.value;
            var curP = pF.value;

            var months = [...new Set(masterData.leads.map(l => l.fullMonth))].sort().reverse();
            mF.innerHTML = '<option value="ALL">전체 달 선택</option>';
            months.forEach(m => mF.innerHTML += `<option value="${m}">${m}</option>`);

            var ps = [...new Set(masterData.leads.map(l => l.partner))].sort();
            pF.innerHTML = '<option value="ALL">파트너 전체</option>';
            ps.forEach(p => pF.innerHTML += `<option value="${p}">${p}</option>`);

            if (curM) mF.value = curM;
            if (curP) pF.value = curP;
            if (mF.selectedIndex === -1) mF.value = "ALL";
            if (pF.selectedIndex === -1) pF.value = "ALL";
        }

        function initSettleFilters() {
            var sM = document.getElementById('settleMonth');
            var curS = sM.value;
            var months = [...new Set(masterData.leads.map(l => l.fullMonth))].sort().reverse();
            if (months.length === 0) months = [new Date().toISOString().slice(0, 7)];
            sM.innerHTML = "";
            months.forEach(m => sM.innerHTML += `<option value="${m}">${m} 정산 기준</option>`);
            if (curS) sM.value = curS;
            if (sM.selectedIndex === -1 && sM.options.length > 0) sM.selectedIndex = 0;
        }

        function applyFilters() {
            var m = document.getElementById('filterMonth').value;
            var p = document.getElementById('filterPartner').value;
            var s = document.getElementById('filterSettlement').value;

            var filtered = masterData.leads.filter(l =>
                (m === "ALL" || l.fullMonth === m) &&
                (p === "ALL" || l.partner === p) &&
                (s === "ALL" || l.settlement === s)
            );

            renderLeads(filtered);

            // [V13.3] 필터링된 결과의 합계 계산 (동적 업데이트)
            var fInc = filtered.reduce((acc, lead) => acc + (lead.isCompleted ? lead.incentive : 0), 0);
            var fSettled = filtered.reduce((acc, lead) => acc + (lead.isCompleted && lead.settlement === '정산완료' ? lead.incentive : 0), 0);
            var fPending = filtered.reduce((acc, lead) => acc + (lead.isCompleted && lead.settlement !== '정산완료' ? lead.incentive : 0), 0);

            document.getElementById('filteredIncentive').textContent = new Intl.NumberFormat().format(fInc) + "원";
            document.getElementById('summary_totalSettled').textContent = new Intl.NumberFormat().format(fSettled) + "원";
            document.getElementById('summary_totalPending').textContent = new Intl.NumberFormat().format(fPending) + "원";

            renderPartners();
        }

        function renderLeads(leads) {
            var body = document.getElementById('leadTableBody'); body.innerHTML = "";
            var bSum = 0; var cSum = 0;
            leads.forEach(item => {
                if (item.isBooking) bSum++; if (item.isCompleted) cSum++;
                var tr = document.createElement('tr');
                var bOn = item.isBooking ? 'bg-blue-600 text-white' : 'bg-white border text-transparent';
                var cOn = item.isCompleted ? 'bg-green-500 text-white' : 'bg-white border text-transparent';
                tr.innerHTML = `
                    <td class="px-6 py-5">
                        <div class="text-[10px] font-black text-slate-900">${item.date}</div>
                        <div class="text-xs font-black text-blue-600 mt-1">${item.apt || '정보없음'}</div>
                    </td>
                    <td class="px-6 py-5 font-black text-xs text-slate-700">${item.partner}</td>
                    <td class="px-4 py-5"><button onclick="toggle(${item.rowId},9,${!item.isBooking})" class="w-8 h-8 rounded-xl ${bOn} mx-auto block text-[9px] active:scale-90 overflow-hidden">✔</button></td>
                    <td class="px-4 py-5"><button onclick="toggle(${item.rowId},10,${!item.isCompleted})" class="w-8 h-8 rounded-xl ${cOn} mx-auto block text-[9px] active:scale-90 overflow-hidden">✔</button></td>
                    <td class="px-6 py-5"><input type="text" value="${new Intl.NumberFormat().format(item.saleAmount)}" oninput="formatInput(this)" onblur="saveAmount(${item.rowId},this.value)" class="w-28 px-3 py-2 bg-slate-50 border rounded-xl text-xs font-black text-right outline-none"></td>
                    <td class="px-6 py-5 font-black text-xs text-slate-800">${new Intl.NumberFormat().format(item.incentive)}원</td>
                    <td class="px-6 py-5 text-right font-black text-[10px] ${item.settlement === '정산완료' ? 'text-blue-500' : 'text-slate-300'}">${item.settlement}</td>
                `;
                body.appendChild(tr);
            });
            document.getElementById('sum_book').textContent = bSum; document.getElementById('sum_comp').textContent = cSum;
        }

        function renderSettleList() {
            var targetMonth = document.getElementById('settleMonth').value;
            var targetType = document.getElementById('settleType').value;
            var statusFilter = document.getElementById('settleStatusFilter').value;
            var body = document.getElementById('settleListBody');
            body.innerHTML = "";

            masterData.partners.forEach(p => {
                if (targetType !== "ALL" && p.type !== targetType) return;

                var pastHistory = 0; // 이월 미정산 + 과거 정산내역
                var currentMonthAmt = 0; // 선택 달 미정산액 또는 실적액

                // [V13.3] 실적 및 정산 내역 통합 계산
                Object.keys(p.pendingMap).forEach(m => {
                    if (m < targetMonth) pastHistory += p.pendingMap[m];
                    else if (m === targetMonth) currentMonthAmt += p.pendingMap[m];
                });

                var isSettledCurrent = false;
                if (statusFilter === "SETTLED") {
                    Object.keys(p.settledMap).forEach(m => {
                        if (m < targetMonth) pastHistory += p.settledMap[m];
                        else if (m === targetMonth) {
                            currentMonthAmt += p.settledMap[m];
                            isSettledCurrent = true;
                        }
                    });
                }

                var totalPending = 0;
                Object.keys(p.pendingMap).forEach(m => { if (m <= targetMonth) totalPending += p.pendingMap[m]; });

                if (statusFilter === "PENDING" && totalPending === 0) return;

                var isEmp = (p.type === "직원");
                var accountInfo = isEmp ? '<span class="text-slate-400 italic">사내급여 합산대상</span>' : (p.bank ? `${p.bank} ${p.account}` : '<span class="text-red-400">계좌 미등록</span>');

                var tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-6 ring-inset">
                        <div class="font-black text-slate-800 text-sm">${p.name}</div>
                        <div class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">${p.type}</div>
                    </td>
                    <td class="px-6 py-6 font-bold text-slate-500">${new Intl.NumberFormat().format(pastHistory)}원</td>
                    <td class="px-6 py-6 font-black text-blue-600">${new Intl.NumberFormat().format(currentMonthAmt)}원</td>
                    <td class="px-6 py-6 font-black text-base text-slate-900">${new Intl.NumberFormat().format(totalPending)}원</td>
                    <td class="px-6 py-6 text-[10px] font-bold text-slate-600">${accountInfo}</td>
                    <td class="px-6 py-6 text-right">
                        ${totalPending > 0 ? `
                        <button onclick="openBulkModal('${p.name}', '${accountInfo.replace(/<[^>]*>/g, "")}', ${totalPending})" 
                            class="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow-md active:scale-95 transition-all">
                            통합정산 요청
                        </button>` : `<span class="text-blue-500 font-black text-xs">정산 완료</span>`}
                    </td>
                `;
                body.appendChild(tr);
            });

            if (body.innerHTML === "") {
                body.innerHTML = '<tr><td colspan="6" class="px-10 py-20 text-center text-slate-300 font-bold">표시할 정산 데이터가 없습니다.</td></tr>';
            }
        }

        function openBulkModal(n, b, a) {
            const btn = document.getElementById('btnBulkConfirm');
            btn.disabled = false;
            btn.textContent = "입금 및 정산 완료";
            document.getElementById('m_name').textContent = n;
            document.getElementById('m_bank').textContent = b;
            document.getElementById('m_amt').textContent = new Intl.NumberFormat().format(a) + "원";
            document.getElementById('bankModal').classList.remove('hidden');

            btn.onclick = function () {
                this.disabled = true;
                this.textContent = "처리 중...";
                google.script.run
                    .withSuccessHandler(() => {
                        document.getElementById('bankModal').classList.add('hidden');
                        loadData();
                    })
                    .withFailureHandler((err) => {
                        alert("정산 처리 중 오류가 발생했습니다: " + err);
                        this.disabled = false;
                        this.textContent = "입금 및 정산 완료";
                    })
                    .settlePartnerBulk(n);
            };
        }

        function renderPartners() {
            var typeF = document.getElementById('partnerTypeFilter').value;
            var body = document.getElementById('partnerTableBody'); body.innerHTML = "";
            masterData.partners.forEach(p => {
                if (typeF !== "ALL" && p.type !== typeF) return;
                var isExp = (p.status === "Expired");
                var tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-8 py-6 font-black text-slate-800 text-xs">${p.name}<br><span class="text-[9px] text-slate-300">${p.type}</span></td>
                    <td class="px-8 py-6">
                        <span class="px-3 py-1 rounded-full text-[9px] font-black whitespace-nowrap ${isExp ? 'bg-red-50 text-red-400' : 'bg-green-50 text-green-500'}">
                            ${isExp ? '비활성/만료' : '정상/재직'}
                        </span>
                    </td>
                    <td class="px-8 py-6 text-right space-x-3">
                        <button onclick="togglePartner('${p.name}', '${isExp ? 'Active' : 'Expired'}')" class="text-[10px] font-black underline ${isExp ? 'text-blue-500' : 'text-red-400'}">${isExp ? '활성화' : '만료처리'}</button>
                        <button onclick="askDeletePartner('${p.name}')" class="text-[10px] font-black underline text-slate-400 hover:text-red-600">완전삭제</button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        function toggle(id, col, val) {
            // [V13.3] Optimistic UI + Local Data Sync
            var lead = masterData.leads.find(l => l.rowId === id);
            if (lead) {
                if (col === 9) lead.isBooking = val;
                if (col === 10) {
                    lead.isCompleted = val;
                    lead.incentive = val ? 20000 : 0;
                }
                applyFilters(); // 즉시 화면 갱신
            }
            google.script.run.updateLeadStatus(id, col, val);
        }
        function formatInput(el) {
            var val = el.value.replace(/[^0-9]/g, '');
            el.value = new Intl.NumberFormat().format(val);
        }
        function saveAmount(id, val) {
            var numericVal = val.replace(/[^0-9]/g, '');
            // [V13.3] Local Sync
            var lead = masterData.leads.find(l => l.rowId === id);
            if (lead) {
                lead.saleAmount = parseFloat(numericVal) || 0;
                // 여기서는 인센티브가 금액에 비례하지 않으므로 추가 로직 생략
            }
            google.script.run.updateSaleAmount(id, numericVal);
        }
        function togglePartner(n, s) { if (confirm(n + "님의 상태를 변경할까요?")) google.script.run.withSuccessHandler(loadData).updatePartnerStatus(n, s); }
        function preRegister() {
            var n = document.getElementById('reg_name').value.trim(); var t = document.getElementById('reg_type').value;
            if (!n) return alert("성함을 입력하세요.");
            google.script.run.withSuccessHandler(() => { alert("등록되었습니다."); loadData(); }).adminPreRegisterPartner(n, t);
        }
        function askDeletePartner(n) {
            if (confirm(n + " 파트너를 완전히 삭제할까요? \n이벤트를 추적할 수 없게 되며 본사 유입으로 처리됩니다.")) {
                google.script.run.withSuccessHandler(loadData).deletePartner(n);
            }
        }
    </script>
</body>

</html>
</body>

</html>