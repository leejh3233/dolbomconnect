<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>돌봄 커넥트 관리자 | 프리미엄 통합 관제</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gothic+A1:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Gothic A1', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .slide-up {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="min-h-screen pb-20">

    <!-- 관리자 인증 (유지하되 디자인 최적화) -->
    <div id="loginSection" class="fixed inset-0 bg-white z-[100] flex items-center justify-center p-6">
        <div class="max-w-sm w-full text-center">
            <div
                class="w-20 h-20 bg-slate-50 rounded-[2rem] flex items-center justify-center mx-auto mb-8 border border-slate-100">
                <svg class="w-8 h-8 text-slate-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                    </path>
                </svg>
            </div>
            <h2 class="text-2xl font-black mb-2 tracking-tight">관리자 인증</h2>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-8">Dolbom Connect Admin Security
            </p>
            <input type="password" id="adminPwd" placeholder="Passcode"
                onkeydown="if(event.key === 'Enter') tryAdminLogin()"
                class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl mb-4 text-center outline-none font-bold text-lg focus:border-blue-500 transition-colors">
            <button onclick="tryAdminLogin()" id="btnLogin"
                class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-all">시스템
                접속</button>
            <p id="loginError" class="text-red-500 text-[10px] font-bold mt-4 hidden">접속 정보가 올바르지 않습니다.</p>
        </div>
    </div>

    <!-- 메인 관리 패널 -->
    <div id="mainSection" class="hidden">
        <header class="bg-white border-b border-slate-100 py-6 px-8 sticky top-0 z-40">
            <div class="max-w-[1400px] mx-auto flex justify-between items-center">
                <h1 class="text-xl font-black tracking-tight">돌봄 커넥트 관리자 <span
                        class="text-slate-200 font-normal mx-2">|</span> <span
                        class="text-xs text-slate-400 font-bold">통합 관제 시스템</span></h1>
                <button onclick="window.top.location.href='<?= scriptUrl ?>?page=portal'"
                    class="bg-slate-50 px-4 py-2 rounded-xl text-[11px] font-black text-slate-600 border border-slate-100">나가기</button>
            </div>
        </header>

        <!-- 3탭 네비게이션 -->
        <nav class="bg-white border-b border-slate-50 px-8 sticky top-[81px] z-30">
            <div class="max-w-[1400px] mx-auto">
                <div class="glass-card flex overflow-x-auto no-scrollbar rounded-[2rem] p-2 mb-6 sm:mb-8 gap-3">
                    <button onclick="switchTab('manage')" id="tab_manage"
                        class="flex-1 py-4 text-xs sm:text-sm font-black text-slate-900 bg-white rounded-2xl shadow-lg transition-all min-w-[80px]">통합관리</button>
                    <button onclick="switchTab('settlement')" id="tab_settlement"
                        class="flex-1 py-4 text-xs sm:text-sm font-black text-slate-400 transition-all min-w-[80px]">통합정산</button>
                    <button onclick="switchTab('partners')" id="tab_partners"
                        class="flex-1 py-4 text-xs sm:text-sm font-black text-slate-400 transition-all min-w-[80px]">인원관리</button>
                </div>
            </div>
        </nav>

        <main class="max-w-[1400px] mx-auto p-8 space-y-8">
            <!-- 상단 요약 (Premium Look) -->
            <div id="topStats" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="glass-card p-8 rounded-[2rem]">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">전체 누적 정산완료</p>
                    <h4 id="stat_totalSettled" class="text-3xl font-black text-blue-600">-</h4>
                </div>
                <div class="glass-card p-8 rounded-[2rem]">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">전체 미정산 잔액</p>
                    <h4 id="stat_totalPending" class="text-3xl font-black text-red-500">-</h4>
                </div>
                <div class="glass-card p-8 rounded-[2rem]">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">필터 설정</p>
                    <div class="flex flex-col gap-2">
                        <select id="monthFilter" onchange="renderAll()"
                            class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-1.5 text-[11px] font-black outline-none"></select>
                        <select id="statusFilter" onchange="renderAll()"
                            class="w-full bg-slate-50 border border-slate-100 rounded-xl px-3 py-1.5 text-[11px] font-black outline-none">
                            <option value="ALL">전체 진행상태</option>
                            <option value="상담대기">상담대기</option>
                            <option value="예약완료">예약완료</option>
                            <option value="시공완료">시공완료</option>
                        </select>
                    </div>
                </div>
                <div class="bg-slate-900 p-8 rounded-[2rem] text-white flex flex-col justify-center">
                    <p class="text-[10px] font-black text-slate-500 uppercase mb-2 tracking-widest">전체 리드 현황</p>
                    <div class="flex justify-between items-end">
                        <h4 id="stat_bookingCount" class="text-2xl font-black">0<span
                                class="text-[10px] text-slate-500 ml-1">건 예약</span></h4>
                        <h4 id="stat_compCount" class="text-2xl font-black text-blue-400">0<span
                                class="text-[10px] text-blue-900 ml-1">건 시공</span></h4>
                    </div>
                </div>
            </div>

            <!-- 섹션 영역 -->
            <div id="section_manage" class="slide-up">
                <div class="glass-card rounded-[2.5rem] overflow-hidden">
                    <table class="w-full text-left bg-white hidden md:table">
                        <thead
                            class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                            <tr>
                                <th class="px-8 py-4">일자</th>
                                <th class="px-8 py-4">파트너/장소</th>
                                <th class="px-8 py-4 text-center">예약</th>
                                <th class="px-8 py-4 text-center">시공</th>
                                <th class="px-8 py-4">매출액</th>
                                <th class="px-8 py-4 text-right">상태</th>
                            </tr>
                        </thead>
                        <tbody id="manageTableBody" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                    <div id="manageCardView" class="md:hidden p-4 space-y-4"></div>
                </div>
            </div>

            <div id="section_settlement" class="hidden slide-up">
                <div class="glass-card rounded-[2.5rem] overflow-hidden">
                    <div class="p-8 border-b border-slate-50 flex justify-between items-center bg-white">
                        <h3 class="text-xl font-black">미정산 항목 일괄 처리</h3>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button id="btn_unsettled" onclick="setSettleMode('unsettled')"
                                class="px-4 py-2 bg-white rounded-lg text-xs font-black shadow-sm">미정산</button>
                            <button id="btn_settled" onclick="setSettleMode('settled')"
                                class="px-4 py-2 text-slate-400 text-xs font-black">완료건</button>
                        </div>
                    </div>
                    <tbody id="settleTableBody"></tbody>
                </div>
            </div>

            <div id="section_partners" class="hidden slide-up">
                <!-- 인원 관리 (기존 디자인 유지) -->
            </div>
        </main>
    </div>

    <!-- 스크립트 (SURGICAL FIXES APPLIED) -->
    <script>
        var master = null;
        var settleMode = "unsettled";

        function tryAdminLogin() {
            var pwd = document.getElementById('adminPwd').value;
            google.script.run.withSuccessHandler(ok => {
                if (ok) {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainSection').classList.remove('hidden');
                    refreshData();
                } else alert("비밀번호가 틀렸습니다.");
            }).verifyAdminPassword(pwd);
        }

        function refreshData() {
            google.script.run.withSuccessHandler(data => {
                master = data;
                initFilters();
                renderAll();
            }).getAdminData();
        }

        function initFilters() {
            var fM = document.getElementById('monthFilter');
            var ms = [...new Set(master.leads.map(l => l.fullMonth))].sort().reverse();
            fM.innerHTML = '<option value="ALL">전체 기간</option>';
            ms.forEach(m => fM.innerHTML += `<option value="${m}">${m}</option>`);
        }

        function renderAll() {
            renderStats();
            renderManage();
            // ... (기타 렌더링 함수)
        }

        function renderStats() {
            var fM = document.getElementById('monthFilter').value;
            var fS = document.getElementById('statusFilter').value;

            var filtered = master.leads.filter(l => {
                var mOk = (fM === "ALL" || l.fullMonth === fM);
                var sOk = false;
                if (fS === "ALL") sOk = true;
                else if (fS === "예약완료") sOk = (l.isBooking === true);
                else if (fS === "시공완료") sOk = (l.isCompleted === true);
                else if (fS === "상담대기") sOk = (!l.isBooking && !l.isCompleted); // SURGICAL FIX
                else sOk = String(l.status || "").includes(fS);
                return mOk && sOk;
            });

            var pending = filtered.filter(l => l.isCompleted && l.settlement !== "정산완료").reduce((a, b) => a + b.incentive, 0);
            var settled = filtered.filter(l => l.isCompleted && l.settlement === "정산완료").reduce((a, b) => a + b.incentive, 0);

            document.getElementById('stat_totalSettled').textContent = fmt(settled) + "원";
            document.getElementById('stat_totalPending').textContent = fmt(pending) + "원";
            document.getElementById('stat_bookingCount').textContent = filtered.filter(l => l.isBooking).length;
            document.getElementById('stat_compCount').textContent = filtered.filter(l => l.isCompleted).length;
        }

        function renderManage() {
            var fM = document.getElementById('monthFilter').value;
            var fS = document.getElementById('statusFilter').value;
            var body = document.getElementById('manageTableBody');

            var targets = master.leads.filter(l => {
                var mOk = (fM === "ALL" || l.fullMonth === fM);
                var sOk = false;
                if (fS === "ALL") sOk = true;
                else if (fS === "예약완료") sOk = (l.isBooking === true);
                else if (fS === "시공완료") sOk = (l.isCompleted === true);
                else if (fS === "상담대기") sOk = (!l.isBooking && !l.isCompleted); // SURGICAL FIX
                else sOk = String(l.status || "").includes(fS);
                return mOk && sOk;
            });

            body.innerHTML = targets.map(l => `
                <tr class="hover:bg-slate-50">
                    <td class="px-8 py-4 font-bold text-slate-400 text-[11px]">${l.date}</td>
                    <td class="px-8 py-4">
                        <div class="font-black text-slate-900">${l.partner}</div>
                        <div class="text-[10px] text-slate-400 font-bold">${l.apt}</div>
                    </td>
                    <td class="px-8 py-4 text-center"><input type="checkbox" ${l.isBooking ? 'checked' : ''} onchange="updateRow(${l.rowId}, 9, this.checked)" class="w-4 h-4 rounded"></td>
                    <td class="px-8 py-4 text-center"><input type="checkbox" ${l.isCompleted ? 'checked' : ''} onchange="updateRow(${l.rowId}, 10, this.checked)" class="w-4 h-4 rounded"></td>
                    <td class="px-8 py-4 font-black">${fmt(l.saleAmount)}원</td>
                    <td class="px-8 py-4 text-right"><span class="px-2 py-1 rounded-lg text-[10px] font-black ${l.isCompleted ? 'bg-blue-50 text-blue-600' : 'bg-slate-100 text-slate-400'}">${l.status}</span></td>
                </tr>
            `).join('');
        }

        function switchTab(t) {
            ['manage', 'settlement', 'partners'].forEach(id => {
                document.getElementById('tab_' + id).classList.toggle('bg-white', id === t);
                document.getElementById('tab_' + id).classList.toggle('shadow-lg', id === t);
                document.getElementById('tab_' + id).classList.toggle('text-slate-900', id === t);
                document.getElementById('tab_' + id).classList.toggle('text-slate-400', id !== t);
                document.getElementById('section_' + id).classList.toggle('hidden', id !== t);
            });
        }

        function fmt(n) { return new Intl.NumberFormat().format(n || 0); }
        function updateRow(id, col, val) { google.script.run.withSuccessHandler(() => refreshData()).updateLeadStatus(id, col, val); }
    </script>
</body>

</html>